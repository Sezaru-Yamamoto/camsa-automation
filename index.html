<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Registro de Citas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Tu CSS existente aquí */
    </style>
</head>
<body>
    <div class="form-container">
        <img src="https://www.maily.com.mx/images/maily_logo.svg" alt="Logo de la Clínica">
        <h2>Registro de Paciente y Cita</h2>
        <form id="patientForm">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required>

            <label for="apellido">Apellido:</label>
            <input type="text" id="apellido" name="apellido" required>

            <label for="telefono">Teléfono:</label>
            <input type="tel" id="telefono" name="telefono" pattern="[0-9]{10}" required>

            <label for="fecha-nacimiento">Fecha de Nacimiento:</label>
            <input type="date" id="fecha-nacimiento" name="fecha-nacimiento" required>

            <label for="correo">Correo Electrónico:</label>
            <input type="email" id="correo" name="correo" required>

            <label for="fecha-cita">Fecha de la Cita:</label>
            <input type="text" id="fecha-cita" name="fecha-cita" required>

            <label for="hora-cita">Hora de la Cita:</label>
            <select id="hora-cita" name="hora-cita" required></select>

            <label for="motivo-consulta">Motivo de Consulta:</label>
            <textarea id="motivo-consulta" name="motivo-consulta" required></textarea>

            <input type="submit" value="Registrar Cita">
            <button id="cambiarCita" type="button">Cambiar Cita</button>
        </form>
    </div>

    <!-- Overlay de confirmación -->
    <div id="confirmationOverlay" class="overlay">
        <div id="confirmationMessage" class="confirmation-box">
            <p>¡Tu cita ha sido registrada correctamente!</p>
            <button id="confirmationButton">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_KEY = 'patOfwFQDiPh6QKCs.84fa051144afd6cc3d3b193de88bd84c733e8219065e55e34f2cb7c5d03b70b7';  // Token de API
            const BASE_ID = 'app0HWHKlb3P6MChm';  // ID de la base
            const TABLE_NAME_CITAS = 'Citas';
            const TABLE_NAME_PACIENTES = 'Pacientes';

            const urlParams = new URLSearchParams(window.location.search);
            const idPaciente = urlParams.get('idPaciente');
            const idCita = urlParams.get('idCita');

            if (idPaciente && idCita) {
                // Cargar datos del paciente y la cita
                Promise.all([
                    fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME_PACIENTES}/${idPaciente}`, {
                        headers: { Authorization: `Bearer ${API_KEY}` }
                    }).then(response => response.json()),
                    fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME_CITAS}/${idCita}`, {
                        headers: { Authorization: `Bearer ${API_KEY}` }
                    }).then(response => response.json())
                ])
                .then(([pacienteData, citaData]) => {
                    document.getElementById('nombre').value = pacienteData.fields.Nombre || '';
                    document.getElementById('apellido').value = pacienteData.fields.Apellido || '';
                    document.getElementById('telefono').value = pacienteData.fields.Telefono || '';
                    document.getElementById('fecha-nacimiento').value = pacienteData.fields['Fecha de Nacimiento'] || '';
                    document.getElementById('correo').value = pacienteData.fields.Correo || '';
                    document.getElementById('fecha-cita').value = citaData.fields.Fecha || '';
                    // Aquí también debes actualizar el select de horas como antes, si es necesario
                })
                .catch(error => console.error('Error cargando datos:', error));
            }

            const fechaCitaInput = document.getElementById('fecha-cita');
            const horaCitaSelect = document.getElementById('hora-cita');

            flatpickr(fechaCitaInput, {
                dateFormat: 'Y-m-d',
                minDate: 'today',
                onChange: function(selectedDates) {
                    const fechaSeleccionada = selectedDates[0];
                    if (fechaSeleccionada) {
                        const fechaCita = fechaSeleccionada.toISOString().split('T')[0];
                        actualizarHorasDisponibles(fechaCita);
                    }
                }
            });

            function fetchHorasOcupadas(fecha) {
                const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME_CITAS}?filterByFormula=AND(IS_SAME({Fecha}, '${fecha}', 'day'))`;

                return fetch(url, {
                    headers: {
                        Authorization: `Bearer ${API_KEY}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    return data.records.map(record => record.fields['Hora']);
                });
            }

            function actualizarHorasDisponibles(fechaCita) {
                fetchHorasOcupadas(fechaCita)
                .then(horasOcupadas => {
                    horaCitaSelect.innerHTML = '';

                    let startHour, endHour;
                    const now = new Date();
                    const selectedDate = new Date(fechaCita);

                    // Define los rangos de horas según el día de la semana
                    if (selectedDate.getDay() === 0) {
                        // Domingo no disponible
                        horaCitaSelect.innerHTML = '<option value="">No disponible</option>';
                        return;
                    } else if (selectedDate.getDay() === 6) {
                        // Sábado
                        startHour = 10;
                        endHour = 16;
                    } else {
                        // Lunes a Viernes
                        startHour = 10;
                        endHour = 18;
                    }

                    for (let hour = startHour; hour < endHour; hour++) {
                        ['00', '30'].forEach(minute => {
                            const hora = `${hour.toString().padStart(2, '0')}:${minute}`;
                            const ocupada = horasOcupadas.includes(hora);

                            const option = document.createElement('option');
                            option.value = hora;
                            option.textContent = hora;

                            // Deshabilita horas ocupadas y horas pasadas si es hoy
                            if (ocupada || 
                                (fechaCita === now.toISOString().split('T')[0] &&
                                 (hour < now.getHours() || 
                                  (hour === now.getHours() && parseInt(minute) <= now.getMinutes())))) {
                                option.disabled = true;
                            }

                            horaCitaSelect.appendChild(option);
                        });
                    }
                });
            }

            const form = document.getElementById('patientForm');
            const confirmationOverlay = document.getElementById('confirmationOverlay');
            const confirmationButton = document.getElementById('confirmationButton');
            const cambiarCitaButton = document.getElementById('cambiarCita');

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                enviarDatosFormulario()
                .then(response => {
                    if (response.ok) {
                        confirmationOverlay.style.display = 'flex';
                    } else {
                        alert('No se logró concretar la cita. Por favor, inténtelo nuevamente.');
                    }
                })
                .catch(error => {
                    alert('Error en la comunicación. Por favor, inténtelo nuevamente.');
                });
            });

            confirmationButton.addEventListener('click', function() {
                confirmationOverlay.style.display = 'none';
                form.reset();
                horaCitaSelect.innerHTML = '';
            });

            cambiarCitaButton.addEventListener('click', function() {
                if (idPaciente && idCita) {
                    window.location.href = `https://hook.us1.make.com/sa972atghsaxg2c85cpkzqwiuybmq91p?idPaciente=${idPaciente}&idCita=${idCita}`;
                } else {
                    alert('No se puede cambiar la cita. Los IDs de paciente y cita no están disponibles.');
                }
            });

            function enviarDatosFormulario() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                return fetch('https://hook.us1.make.com/sa972atghsaxg2c85cpkzqwiuybmq91p', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
            }
        });
    </script>
</body>
</html>
